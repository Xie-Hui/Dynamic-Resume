

var json = {
    "A":{
        "title": "This is A",
        "AA":{
            "content": "this is AA",
            "AAA":{
                "Aa":"Aaaa",
                "Ab":"Abbb",
                "Ac":"Accc"
            },
            "AAB":{
                "Aa":"Aaaa",
                "Ab":"Abbb",
                "Ac":"Accc"
            },
            "AAC":{
                "Aa":"Aaaa",
                "Ab":"Abbb",
                "Ac":"Accc"
            }
        },
        "AB":{
            "content": "this is AB",
            "ABA":{
                "Ba":"Baaa",
                "Bb":"Bbbb",
                "Bc":"Bccc"
            },
            "ABB":{
                "Ba":"Baaa",
                "Bb":"Bbbb",
                "Bc":"Bccc"
            },
            "ABC":{
                "Ba":"Baaa",
                "Bb":"Bbbb",
                "Bc":"Bccc"
            }
        },
        "AC":{
            "content": "this is AC",
            "ACA":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            },
            "ACB":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            },
            "ACC":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            }
        },
        "AD":{
            "content": "this is AC",
            "ACA":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            },
            "ACB":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            },
            "ACC":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            }
        },
        "AE":{
            "content": "this is AC",
            "ACA":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            },
            "ACB":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            },
            "ACC":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            }
        },
        "AF":{
            "content": "this is AC",
            "ACA":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            },
            "ACB":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            },
            "ACC":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            }
        },
        "AG":{
            "content": "this is AC",
            "ACA":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            },
            "ACB":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            },
            "ACC":{
                "Ca":"Caaa",
                "Cb":"Cbbb",
                "Cc":"Cccc"
            }
        }
    }
}

/*

var json = {
  "houses": [
    {
      "name": "Starks",
      "wikiSuffix": "House_Stark",
      "people": [
        {
          "name": "Eddard \"Ned\" Stark",
          "description": "Lord of Winterfell - Warden of the North - Hand of the King - Married to Catelyn (Tully) Stark",
          "imageSuffix": "eddard-stark",
          "wikiSuffix": "Eddard_Stark"
        },
        {
          "name": "Benjen Stark",
          "description": "Brother of Eddard Stark - First ranger of the Night's Watch",
          "imageSuffix": "benjen-stark",
          "wikiSuffix": "Benjen_Stark"
        },
        {
          "name": "Robb Stark",
          "description": "Son of Eddard and Catelyn Stark - Direwolf: Grey Wind",
          "imageSuffix": "robb-stark",
          "wikiSuffix": "Robb_Stark"
        },
        {
          "name": "Sansa Stark",
          "description": "Daughter of Eddard and Catelyn Stark - Direwolf: Lady",
          "imageSuffix": "sansa-stark",
          "wikiSuffix": "Sansa_Stark"
        },
        {
          "name": "Arya Stark",
          "description": "Daughter of Eddard and Catelyn Stark - Direwolf: Nymeria",
          "imageSuffix": "arya-stark",
          "wikiSuffix": "Arya_Stark"
        },
        {
          "name": "Brandon \"Bran\" Stark",
          "description": "Son of Eddard and Catelyn Stark - Direwolf: Summer",
          "imageSuffix": "brandon-stark",
          "wikiSuffix": "Brandon_Stark"
        },
        {
          "name": "Rickon Stark",
          "description": "Son of Eddard and Catelyn Stark - Direwolf: Shaggydog",
          "imageSuffix": "rickon-stark",
          "wikiSuffix": "Rickon_Stark"
        },
        {
          "name": "Jon Snow",
          "description": "Bastard son of Eddard Stark - Steweard in the Night's Watch - Direwolf: Ghost",
          "imageSuffix": "jon-snow",
          "wikiSuffix": "Jon_Snow"
        }
      ]
    },



    {
      "name": "Lannisters",
      "wikiSuffix": "House_Lannister",
      "people": [
        {
          "name": "Tywin Lannister",
          "description": "Lord of Casterly Rock - Warden of the West",
          "imageSuffix": "tywin-lannister",
          "wikiSuffix": "Tywin_Lannister"
        },
        {
          "name": "Tyrion Lannister",
          "description": "Son of Tywin Lannister - The Imp",
          "imageSuffix": "tyrion-lannister",
          "wikiSuffix": "Tyrion_Lannister"
        },
        {
          "name": "Jaime Lannister",
          "description": "The Kingslayer - Knight of the Kingsgaurd - Son of Tywin Lannister",
          "imageSuffix": "jaime-lannister",
          "wikiSuffix": "Jaime_Lannister"
        },
        {
          "name": "Queen Cersei (Lannister) Baratheon",
          "description": "Married to King Robert Baratheon - Daughter of Tywin Lannister",
          "imageSuffix": "cersei-lannister",
          "wikiSuffix": "Cersei_Lannister"
        }
      ]
    },


    {
      "name": "Baratheons",
      "wikiSuffix": "House_Baratheon",
      "people": [
        {
          "name": "King Robert Baratheon",
          "description": "The first of his name - Lord of the Seven Kingdoms",
          "imageSuffix": "robert-baratheon",
          "wikiSuffix": "Robert_Baratheon"
        },
        {
          "name": "Stannis Baratheon",
          "description": "Lord of Dragonstone - Master of Ships - Brother of Robert Baratheon",
          "imageSuffix": "stannis-baratheon",
          "wikiSuffix": "Stannis_Baratheon"
        },
        {
          "name": "Renly Baratheon",
          "description": "Lord of Storm's End - Master of Laws - Brother of Robert Baratheon",
          "imageSuffix": "renly-baratheon",
          "wikiSuffix": "Renly_Baratheon"
        },
        {
          "name": "Joffrey Baratheon",
          "description": "Heir to the Iron Throne - Son of Robert and Cersei Baratheon",
          "imageSuffix": "joffrey-baratheon",
          "wikiSuffix": "Joffrey_Baratheon"
        },
        {
          "name": "Tommen Baratheon",
          "description": "Son of Robert and Cersei Baratheon",
          "imageSuffix": "tommen-baratheon",
          "wikiSuffix": "Tommen_Baratheon"
        },
        {
          "name": "Myrcella Baratheon",
          "description": "Daughter of Robert and Cersei Baratheon",
          "imageSuffix": "myrcella-baratheon",
          "wikiSuffix": "Myrcella_Baratheon"
        }
      ]
    },




    {
      "name": "Targaryens",
      "wikiSuffix": "House_Targaryen",
      "people": [
        {
          "name": "Daenerys Targaryen",
          "description": "Stormborn - Khaleesi of the Dothraki - The Unburnt - Mother of Dragons - Daughter of Aerys II Targaryen \"The Mad King\"",
          "imageSuffix": "daenerys-targaryen",
          "wikiSuffix": "Daenerys_Targaryen"
        },
        {
          "name": "Viserys Targaryen",
          "description": "The Beggar King - Son of Aerys II Targaryen \"The Mad King\"",
          "imageSuffix": "viserys-targaryen",
          "wikiSuffix": "Viserys_Targaryen"
        }
      ]
    },



    {
      "name": "Greyjoys",
      "wikiSuffix": "House_Greyjoy",
      "people": [
        {
          "name": "Balon Greyjoy",
          "description": "Lord Reaper of Pyke - Head of House Greyjoy",
          "imageSuffix": "balon-greyjoy",
          "wikiSuffix": "Balon_Greyjoy"
        },
        {
          "name": "Theon Greyjoy",
          "description": "Ward of the Starks - Heir to the Iron Islands - Son of Balon Greyjoy",
          "imageSuffix": "theon-greyjoy",
          "wikiSuffix": "Theon_Greyjoy"
        },
        {
          "name": "Yara Greyjoy",
          "description": "Ironborn - Son of Balon Greyjoy",
          "imageSuffix": "yara-greyjoy",
          "wikiSuffix": "Yara_Greyjoy"
        }

      ]
    },

    {
      "name": "Tyrells",
      "wikiSuffix": "House_Tyrell",
      "people": [
        {
          "name": "Margaery (Tyrell) Baratheon",
          "description": "Wife of Renly Baratheon - Sister of Loras Tyrell - Granddaughter of Olenna Tyrell",
          "imageSuffix": "margaery-tyrell",
          "wikiSuffix": "Margaery_Tyrell"
        },
        {
          "name": "Loras Tyrell",
          "description": "Heir to Highgarden - Commander of the Kings Gaurd - Brother of Margaery Baratheon",
          "imageSuffix": "loras-tyrell",
          "wikiSuffix": "Loras_Tyrell"
        }

      ]
    },

    {
      "name": "Tullys",
      "wikiSuffix": "House_Tully",
      "people": [
        {
          "name": "Catelyn (Tully) Stark",
          "description": "Married to Eddard Stark - Daughter of Hoster Tully",
          "imageSuffix": "catelyn-tully",
          "wikiSuffix": "Catelyn_Tully"
        },
        {
          "name": "Lysa (Tully) Arryn",
          "description": "Widow of Jon Arryn - Daughter of Hoster Tully",
          "imageSuffix": "lysa-tully",
          "wikiSuffix": "Lysa_Tully"
        },
        {
          "name": "Edmure Tully",
          "description": "Heir to Riverrun - Son of Hoster Tully",
          "imageSuffix": "edmure-tully",
          "wikiSuffix": "Edmure_Tully"
        },
        {
          "name": "Brynden Tully",
          "description": "Lord of Riverrun - Head of House Tully - Brother of Hoster Tully",
          "imageSuffix": "brynden-tully",
          "wikiSuffix": "Brynden_Tully"
        }

      ]
    },

    {
      "name": "Redwyne",
      "wikiSuffix": "House_Redwyne",
      "people": [
        {
          "name": "Olenna (Redwyne) Tyrell",
          "description": "Matriarch of House Tyrell - Queen of Thorns",
          "imageSuffix": "olenna-tyrell",
          "wikiSuffix": "Olenna_Tyrell"
        }

      ]
    },

    {
      "name": "Freys",
      "wikiSuffix": "House_Freys",
      "people": [
        {
          "name": "Walder Frey",
          "description": "Lord of the Crossing - Head of House Frey",
          "imageSuffix": "walder-frey",
          "wikiSuffix": "Walder_Frey"
        }

      ]
    },

    {
      "name": "Arryns",
      "wikiSuffix": "House_Arryns",
      "people": [
        {
          "name": "Jon Arryn",
          "description": "Lord of the Eyrie - Head of House Arryn - Warden of the East - Defender of the Vale",
          "imageSuffix": "jon-arryn",
          "wikiSuffix": "Jon_Arryn"
        }

      ]
    },

    {
      "name": "Dothrakis",
      "wikiSuffix": "House_Dothrakis",
      "people": [
        {
          "name": "Khal Drogo",
          "description": "Leader of the Dothraki people - Dothraki Warlord - Married to Daenerys Targaryen",
          "imageSuffix": "khal-drogo",
          "wikiSuffix": "Drogo"
        }

      ]
    }

  ]
}
*/
var camera, scene, renderer
var cameraDistance = 1000
var cameraPositionQueue = []

var objects = []
    targets = []
    locations = []

var sceneWebgl, rendererWebgl;

window.onload = function(){
    setup();
    animate();
}


function setup() {

    camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 10000 );
	camera.position.z = cameraDistance;
    cameraPositionQueue.push(camera)
	scene = new THREE.Scene();

    //vanishPt = new THREE.Vector3(0,0,-100);
    //camera.lookAt(vanishPt);


    createCvElements()

    renderer = new THREE.CSS3DRenderer();
	renderer.setSize( window.innerWidth, window.innerHeight );
	renderer.domElement.style.position = 'absolute';
	document.getElementById( 'container' ).appendChild( renderer.domElement );

    //createParticles();
}


function animate() {
    requestAnimationFrame( animate );
    TWEEN.update();
    render();
}

function render() {
    //particleUpdate();
    renderer.render( scene, camera );
    //rendererWebgl.render( sceneWebgl, camera );
    //cameraWander();
}

function transform(targets, duration){

    TWEEN.removeAll();
    //move camera to starting location
    for ( i = 0; i < objects.length; i++ ) {

        var object = objects[i]
        var target = targets[i]

        new TWEEN.Tween( object.position )
            .to({ x: target.position.x, y: target.position.y, z: target.position.z }, duration )
            .easing( TWEEN.Easing.Exponential.InOut )
            .onUpdate( function(){

                //camera.position.x = objects[0].position.x
                //camera.position.y = objects[0].position.y

            } )
            .start();

    }

    new TWEEN.Tween( this )
            .to( {}, duration * 2 )
            .onUpdate( render )
            .start();

}

function moveCamera( target, duration ) {

    TWEEN.removeAll();

    new TWEEN.Tween( camera.position )
        .to({ x: target.position.x, y: target.position.y, z: target.position.z }, duration )
        .easing( TWEEN.Easing.Exponential.InOut )
        .onUpdate( function(){

            //camera.position.x = objects[0].position.x
            //camera.position.y = objects[0].position.y

        } )
        .start();

}

Math.radians = function(degrees) {
  return degrees * Math.PI / 180;
};

function createDOM(

    parentNode,
    JsonData = json,  //default

){

    for (var key in JsonData){

        //console.log(key);
        var newNode = document.createElement("div")

        if (JsonData[key] instanceof Object){

            newNode.id = key + "-menu"
            newNode.className = "menu"
            createDOM(newNode, JsonData[key])

            //create a button portal
            var btn = document.createElement("BUTTON")
            btn.className = "myButton"
            btn.textContent = key
            parentNode.appendChild(btn)



        }
        else {

            //newNode.className = key
            newNode.className = "panel"
            newNode.textContent = JsonData[key]

        }

        parentNode.appendChild(newNode)

    }

}

function getPosition( depth, index, nodeTotal, centerPosition ) {

    var r = 1000 / (depth + 1) //radius depend on depth

    //root start from [0,0,0]
    if (depth == 0) {

        return ( [0, 0, 0] )

    }
    if (nodeTotal == 0) {

        return([

            centerPosition[0],
            centerPosition[1],
            centerPosition[2] - (depth + 1) * 1000

        ])

    }

    return([

        centerPosition[0] + r * Math.sin(Math.radians(index * 360 / nodeTotal)),  // x
        centerPosition[1] + r * Math.cos(Math.radians(index * 360 / nodeTotal)),  // y
        centerPosition[2] - (depth + 1) * 200//z

    ])

}

function createCSSobjs(

    currentNode,
    parentNode,
    parentNode_position = [0, 0, 0],
    nodeDepth = 0,
    nodeIndex = 0

){

    console.log("currentNode: ", currentNode);
    console.log("depth: ", nodeDepth);
    console.log("index: ", nodeIndex);

    var siblings = parentNode.childNodes
    console.log("siblings: ", siblings);
    var nodeTotal = 0;
    for ( var i = 0; i < parentNode.childElementCount; i++ ) {

        if ( siblings[ i ].id && siblings[ i ].id.indexOf("menu") != -1 ) {

            nodeTotal++

        }

    }
    console.log("nodeTotal: ", nodeTotal);

    var object = new THREE.CSS3DObject(currentNode)

    //update position
    var position = getPosition( nodeDepth, nodeIndex, nodeTotal, parentNode_position )
    object.position.x = position[0]
    object.position.y = position[1]
    object.position.z = position[2]
    console.log("position: ", position);
    objects.push(object)
    scene.add( object )
    //


    var children = currentNode.childNodes
    var k = 0
    for ( var i = 0; i < currentNode.childElementCount; i++ ) {

        //console.log( children[ i ] );

        if ( children[ i ].id.indexOf("menu") != -1 ) {

            console.log(children[ i ].id);
            createCSSobjs( children[ i ], currentNode, position, nodeDepth+1, k)
            k++

        }

    }

}

function cameraRollback() {

    if ( cameraPositionQueue.length ) {

        var currentCameraPosition = cameraPositionQueue.pop()
        console.log(currentCameraPosition)
        moveCamera( currentCameraPosition, 1000)

    }

}

function createEvents() {

    var btns = document.getElementsByClassName("myButton");
    console.log("myButtons: ", btns);

    console.log("object CLASS:", objects[1].element.className);

    for ( var i = 0; i < btns.length; i++ ) {

        btns[i].addEventListener('click', function() {

            console.log(this.textContent);
            console.log(camera.position);
            console.log("objects: ", objects);

            var targetId = this.textContent + "-menu"
            for ( var j = 0; j < objects.length; j++ ){

                    var object = objects[ j ]
                    if (object.element.id == targetId) {

                        var tmp = new THREE.Object3D();
                        tmp.position.x = object.position.x
                        tmp.position.y = object.position.y
                        tmp.position.z = object.position.z + cameraDistance
                        //update lastCameraPosition
                        var currentCameraPosition = new THREE.Object3D()
                        currentCameraPosition.position.x = camera.position.x
                        currentCameraPosition.position.y = camera.position.y
                        currentCameraPosition.position.z = camera.position.z
                        cameraPositionQueue.push(currentCameraPosition)
                        moveCamera( tmp, 1000)

                    }

            }

        }, false);

    }

    //right click to go back to previous camera position
    document.addEventListener("mousedown", function(e) {
        console.log(e); // you can inspect the click event

        if (e.which === 3) { // right click = 3, left click = 1

            //console.log("right click");
            cameraRollback()

        }
    });

    //double click on screen
    document.addEventListener("dblclick", function() {

        //console.log("double cllick!");
        cameraRollback()

    })

    // prevent context menu show up
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    }, false);

}

function createCvElements(){

    //tmp = document.createElement("div")
    //tmp.className = "root"
    var container = document.getElementById("container")
    createDOM(container)

    //console.log(container.childNodes[2]);
    createCSSobjs(container.childNodes[2], container )

    //adding the event listeners
    createEvents()



}
